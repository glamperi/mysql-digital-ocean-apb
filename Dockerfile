FROM ansibleplaybookbundle/apb-base

LABEL "com.redhat.apb.spec"=\
"X3BhcmFtczogJl9wYXJhbXMKICAtIG5hbWU6IHNlcnZpY2VfbmFtZQogICAgdGl0bGU6IERhdGFi\
YXNlIHNlcnZpY2UgbmFtZQogICAgZGVzY3JpcHRpb246IFRoZSBuYW1lIG9mIHRoZSBzZXJ2aWNl\
LiBVc2VkIHRvIG5hbWUgZHJvcGxldCBhbmQgT3BlbnNoaXQgc2VydmljZQogICAgdHlwZTogc3Ry\
aW5nCiAgICBkZWZhdWx0OiBkb215c3FsCiAgICBwYXR0ZXJuOiAiXlthLXpBLVowLTldK1thLXpB\
LVowLTldKlthLXpBLVowLTldKyQiCiAgICByZXF1aXJlZDogdHJ1ZQogIC0gbmFtZTogZGJfbmFt\
ZQogICAgdGl0bGU6IERhdGFiYXNlIG5hbWUKICAgIGRlc2NyaXB0aW9uOiBUaGUgbmFtZSBvZiB0\
aGUgTXlTUUwgZGF0YWJhc2UKICAgIHR5cGU6IHN0cmluZwogICAgZGVmYXVsdDogY2F0YWxvZwog\
ICAgcGF0dGVybjogIl5bYS16QS1aMC05X10qW2EtekEtWl9dK1thLXpBLVowLTlfXSokIgogICAg\
cmVxdWlyZWQ6IHRydWUKICAtIG5hbWU6IGRiX3VzZXIKICAgIHRpdGxlOiBEYXRhYmFzZSB1c2Vy\
bmFtZSAKICAgIGRlc2NyaXB0aW9uOiBVc2VybmFtZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBjb25u\
ZWN0IHRvIE15U1FMCiAgICB0eXBlOiBzdHJpbmcKICAgIGRlZmF1bHQ6IGFkbWluCiAgICBwYXR0\
ZXJuOiAiXlthLXpBLVowLTlfXSpbYS16QS1aX10rW2EtekEtWjAtOV9dKiQiCiAgICByZXF1aXJl\
ZDogdHJ1ZQogIC0gbmFtZTogZGJfcGFzc3dvcmQKICAgIHRpdGxlOiBEYXRhYmFzZSB1c2VyIHBh\
c3N3b3JkCiAgICBkZXNjcmlwdGlvbjogUGFzc3dvcmQgdG8gY29ubmVjdCB0byBNeVNRTCAoZ2Vu\
ZXJhdGVkIGlmIGJsYW5rKQogICAgdHlwZTogc3RyaW5nCiAgICByZXF1aXJlZDogdHJ1ZQogICAg\
ZGlzcGxheV90eXBlOiBwYXNzd29yZAogIC0gbmFtZTogZGJfcm9vdF9wYXNzd29yZAogICAgdGl0\
bGU6IERhdGFiYXNlIHJvb3QgdXNlciBwYXNzd29yZAogICAgZGVzY3JpcHRpb246IFJvb3QgdXNl\
ciBwYXNzd29yZCB0byBjb25uZWN0IHRvIE15U1FMIChnZW5lcmF0ZWQgaWYgYmxhbmspCiAgICB0\
eXBlOiBzdHJpbmcKICAgIHJlcXVpcmVkOiB0cnVlCiAgICBkaXNwbGF5X3R5cGU6IHBhc3N3b3Jk\
CiAgLSBuYW1lOiBkb19hY2Nlc3NfdG9rZW4KICAgIHRpdGxlOiBEaWdpdGFsIE9jZWFuIEFQSSBh\
Y2Nlc3MgdG9rZW4KICAgIGRlc2NyaXB0aW9uOiBEaWdpdGFsIE9jZWFuIEFQSSBhY2Nlc3MgdG9r\
ZW4KICAgIHR5cGU6IHN0cmluZwogICAgZGVmYXVsdDogZDYyNDMzNzViMzRiMjIyYTk3YTNkMGI0\
ZGJjMzUwNGEyYWUwMjIzNjMzN2UzOWQ5YTk1NDdmMGM1ZmRlNmQ2NQogICAgcmVxdWlyZWQ6IHRy\
dWUgICAgCnZlcnNpb246IDEuMApuYW1lOiBteXNxbC1kaWdpdGFsLW9jZWFuLWFwYgpkZXNjcmlw\
dGlvbjogTXlTUUwgZGF0YWJhc2UgZnJvbSBEaWdpdGFsIE9jZWFuCmJpbmRhYmxlOiB0cnVlCmFz\
eW5jOiBvcHRpb25hbAp0YWdzOgotIGRhdGFiYXNlCi0gbXlzcWwKbWV0YWRhdGE6CiAgZGlzcGxh\
eU5hbWU6ICJEaWdpdGFsIE9jZWFuIE15U1FMIChBUEIpIgogIGxvbmdEZXNjcmlwdGlvbjogIk15\
U1FMIDUuNyBydW5uaW5nIG9uIENlbnRPcyA3LjQgaW4gRGlnaXRhbCBPY2VhbiIKICBjb25zb2xl\
Lm9wZW5zaGlmdC5pby9pY29uQ2xhc3M6IGljb24tbXlzcWwtZGF0YWJhc2UKICBwcm92aWRlckRp\
c3BsYXlOYW1lOiAiUmVkIEhhdCwgSW5jLiIKcGxhbnM6CiAgLSBuYW1lOiA1MTJtYgogICAgZGVz\
Y3JpcHRpb246IFNtYWxsIGRyb3BsZXQgd2l0aCBNeVNRTAogICAgZnJlZTogdHJ1ZQogICAgbWV0\
YWRhdGE6CiAgICAgIGRpc3BsYXlOYW1lOiBEZWZhdWx0ICg1MTJNQikKICAgICAgbG9uZ0Rlc2Ny\
aXB0aW9uOiBUaGlzIHBsYW4gcHJvdmlkZXMgc21hbGwgKDUxMk1CKSBkcm9wbGV0IGZyb20gRGln\
aXRhbCBPY2VhbiB3aXRoIE15U1FMCiAgICAgIGNvc3Q6ICQwLjAwCiAgICBwYXJhbWV0ZXJzOiAq\
X3BhcmFtcwogIC0gbmFtZTogMmdiCiAgICBkZXNjcmlwdGlvbjogU21hbGwgZHJvcGxldCB3aXRo\
IE15U1FMCiAgICBmcmVlOiB0cnVlCiAgICBtZXRhZGF0YToKICAgICAgZGlzcGxheU5hbWU6IE1l\
ZGl1bSAoMkdCKQogICAgICBsb25nRGVzY3JpcHRpb246IFRoaXMgcGxhbiBwcm92aWRlcyBtZWRp\
dW0gKDJHQikgZHJvcGxldCBmcm9tIERpZ2l0YWwgT2NlYW4gd2l0aCBNeVNRTAogICAgICBjb3N0\
OiAkMTAuMDAgbW9udGhseQogICAgcGFyYW1ldGVyczogKl9wYXJhbXMKICAtIG5hbWU6IDRnYgog\
ICAgZGVzY3JpcHRpb246IFNtYWxsIGRyb3BsZXQgd2l0aCBNeVNRTAogICAgZnJlZTogdHJ1ZQog\
ICAgbWV0YWRhdGE6CiAgICAgIGRpc3BsYXlOYW1lOiBMYXJnZSAoNEdCKQogICAgICBsb25nRGVz\
Y3JpcHRpb246IFRoaXMgcGxhbiBwcm92aWRlcyBsYXJnZSAoNEdCKSBkcm9wbGV0IGZyb20gRGln\
aXRhbCBPY2VhbiB3aXRoIE15U1FMCiAgICAgIGNvc3Q6ICQ0MC4wMCBtb250aGx5CiAgICBwYXJh\
bWV0ZXJzOiAqX3BhcmFtcwo="

RUN yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-$(rpm -E '%{rhel}').noarch.rpm && yum -y update && yum -y install python git python-pip && yum clean all
RUN pip install --upgrade pip && pip install 'dopy>=0.3.7,<=0.3.7'

RUN chown -R apb:0 /opt/apb && chmod -R g=u /opt/apb /etc/passwd

COPY playbooks /opt/apb/actions
COPY roles /opt/apb/actions/roles
RUN chmod -R g=u /opt/{ansible,apb}
USER apb
ENV ANSIBLE_HOST_KEY_CHECKING false
