FROM ansibleplaybookbundle/apb-base

LABEL "com.redhat.apb.spec"=\
"X3BhcmFtczogJl9wYXJhbXMKICAtIG5hbWU6IHNlcnZpY2VfbmFtZQogICAgdGl0bGU6IERhdGFi\
YXNlIHNlcnZpY2UgbmFtZQogICAgZGVzY3JpcHRpb246IFRoZSBuYW1lIG9mIHRoZSBzZXJ2aWNl\
LiBVc2VkIHRvIG5hbWUgZHJvcGxldCBhbmQgT3BlbnNoaXQgc2VydmljZQogICAgdHlwZTogc3Ry\
aW5nCiAgICBkZWZhdWx0OiBkb215c3FsCiAgICBwYXR0ZXJuOiAiXlthLXpBLVowLTldK1thLXpB\
LVowLTldKlthLXpBLVowLTldKyQiCiAgICByZXF1aXJlZDogdHJ1ZQogIC0gbmFtZTogcmVnaW9u\
CiAgICB0aXRsZTogVGFyZ2V0IHJlZ2lvbgogICAgZGVzY3JpcHRpb246IFJlZ2lvbiB3aGVyZSBW\
TSB3aWxsIGJlIHByb3Zpc2lvbmVkCiAgICB0eXBlOiBlbnVtCiAgICBlbnVtOiBbbnljMSxueWMy\
LG55YzMsc2ZvMSxzZm8yLGFtczIsYW1zMyxzZ3AxLGxvbjEsZnJhMSx0b3IxLGJscjFdCiAgICBk\
ZWZhdWx0OiBzZm8xCiAgICByZWd1aXJlZDogdHJ1ZQogICAgZGlzcGxheV90eXBlOiBzZWxlY3QK\
ICAtIG5hbWU6IG15c3FsX2RhdGFiYXNlCiAgICB0aXRsZTogRGF0YWJhc2UgbmFtZQogICAgZGVz\
Y3JpcHRpb246IFRoZSBuYW1lIG9mIHRoZSBNeVNRTCBkYXRhYmFzZQogICAgdHlwZTogc3RyaW5n\
CiAgICBkZWZhdWx0OiBjYXRhbG9nCiAgICBwYXR0ZXJuOiAiXlthLXpBLVowLTlfXSpbYS16QS1a\
X10rW2EtekEtWjAtOV9dKiQiCiAgICByZXF1aXJlZDogdHJ1ZQogIC0gbmFtZTogbXlzcWxfdXNl\
cgogICAgdGl0bGU6IERhdGFiYXNlIHVzZXJuYW1lIAogICAgZGVzY3JpcHRpb246IFVzZXJuYW1l\
IHRoYXQgd2lsbCBiZSB1c2VkIHRvIGNvbm5lY3QgdG8gTXlTUUwKICAgIHR5cGU6IHN0cmluZwog\
ICAgZGVmYXVsdDogYWRtaW4KICAgIHBhdHRlcm46ICJeW2EtekEtWjAtOV9dKlthLXpBLVpfXStb\
YS16QS1aMC05X10qJCIKICAgIHJlcXVpcmVkOiB0cnVlCiAgLSBuYW1lOiBteXNxbF9wYXNzd29y\
ZAogICAgdGl0bGU6IERhdGFiYXNlIHVzZXIgcGFzc3dvcmQKICAgIGRlc2NyaXB0aW9uOiBQYXNz\
d29yZCB0byBjb25uZWN0IHRvIE15U1FMIChnZW5lcmF0ZWQgaWYgYmxhbmspCiAgICB0eXBlOiBz\
dHJpbmcKICAgIHJlcXVpcmVkOiB0cnVlCiAgICBkaXNwbGF5X3R5cGU6IHBhc3N3b3JkCnZlcnNp\
b246IDEuMApuYW1lOiBteXNxbC1kaWdpdGFsLW9jZWFuLWFwYgpkZXNjcmlwdGlvbjogTXlTUUwg\
ZGF0YWJhc2UgZnJvbSBEaWdpdGFsIE9jZWFuCmJpbmRhYmxlOiB0cnVlCmFzeW5jOiBvcHRpb25h\
bAp0YWdzOgotIGRhdGFiYXNlCi0gbXlzcWwKbWV0YWRhdGE6CiAgZGlzcGxheU5hbWU6ICJEaWdp\
dGFsIE9jZWFuIE15U1FMIChBUEIpIgogIGxvbmdEZXNjcmlwdGlvbjogIk15U1FMIDUuNyBydW5u\
aW5nIG9uIENlbnRPcyA3LjQgaW4gRGlnaXRhbCBPY2VhbiIKICBjb25zb2xlLm9wZW5zaGlmdC5p\
by9pY29uQ2xhc3M6IGljb24tbXlzcWwtZGF0YWJhc2UKICBwcm92aWRlckRpc3BsYXlOYW1lOiAi\
UmVkIEhhdCwgSW5jLiIKcGxhbnM6CiAgLSBuYW1lOiA1MTJtYgogICAgZGVzY3JpcHRpb246IFNt\
YWxsIGRyb3BsZXQgd2l0aCBNeVNRTAogICAgZnJlZTogdHJ1ZQogICAgbWV0YWRhdGE6CiAgICAg\
IGRpc3BsYXlOYW1lOiBEZWZhdWx0ICg1MTJNQikKICAgICAgbG9uZ0Rlc2NyaXB0aW9uOiBUaGlz\
IHBsYW4gcHJvdmlkZXMgc21hbGwgKDUxMk1CKSBkcm9wbGV0IGZyb20gRGlnaXRhbCBPY2VhbiB3\
aXRoIE15U1FMCiAgICAgIGNvc3Q6ICQwLjAwCiAgICBwYXJhbWV0ZXJzOiAqX3BhcmFtcwogIC0g\
bmFtZTogMmdiCiAgICBkZXNjcmlwdGlvbjogU21hbGwgZHJvcGxldCB3aXRoIE15U1FMCiAgICBm\
cmVlOiB0cnVlCiAgICBtZXRhZGF0YToKICAgICAgZGlzcGxheU5hbWU6IE1lZGl1bSAoMkdCKQog\
ICAgICBsb25nRGVzY3JpcHRpb246IFRoaXMgcGxhbiBwcm92aWRlcyBtZWRpdW0gKDJHQikgZHJv\
cGxldCBmcm9tIERpZ2l0YWwgT2NlYW4gd2l0aCBNeVNRTAogICAgICBjb3N0OiAkMTAuMDAgbW9u\
dGhseQogICAgcGFyYW1ldGVyczogKl9wYXJhbXMKICAtIG5hbWU6IDRnYgogICAgZGVzY3JpcHRp\
b246IFNtYWxsIGRyb3BsZXQgd2l0aCBNeVNRTAogICAgZnJlZTogdHJ1ZQogICAgbWV0YWRhdGE6\
CiAgICAgIGRpc3BsYXlOYW1lOiBMYXJnZSAoNEdCKQogICAgICBsb25nRGVzY3JpcHRpb246IFRo\
aXMgcGxhbiBwcm92aWRlcyBsYXJnZSAoNEdCKSBkcm9wbGV0IGZyb20gRGlnaXRhbCBPY2VhbiB3\
aXRoIE15U1FMCiAgICAgIGNvc3Q6ICQ0MC4wMCBtb250aGx5CiAgICBwYXJhbWV0ZXJzOiAqX3Bh\
cmFtcwo="

RUN yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-$(rpm -E '%{rhel}').noarch.rpm && yum -y update && yum -y install python git python-pip && yum clean all
RUN pip install --upgrade pip && pip install 'dopy>=0.3.7,<=0.3.7'

RUN chown -R apb:0 /opt/apb && chmod -R g=u /opt/apb /etc/passwd

COPY playbooks /opt/apb/actions
COPY roles /opt/apb/actions/roles
RUN chmod -R g=u /opt/{ansible,apb}
USER apb
ENV ANSIBLE_HOST_KEY_CHECKING false
